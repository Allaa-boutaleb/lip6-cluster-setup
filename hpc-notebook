#!/bin/bash
# HPC Manager for LIP6 Cluster
# Allaa Boutaleb - allaa.boutaleb@lip6.fr
set -e

BLUE='\033[1;34m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
RED='\033[1;31m'
CYAN='\033[1;36m'
DIM='\033[2m'
BOLD='\033[1m'
NC='\033[0m'

TUNNEL_DIR="/tmp/jupyter_tunnels_$(whoami)"
mkdir -p "$TUNNEL_DIR" 2>/dev/null

# Find a free local port for SSH tunneling
find_free_port() {
    python3 -c 'import socket; s=socket.socket(); s.bind(("",0)); print(s.getsockname()[1]); s.close()'
}

# ---- Input validation ----

is_int()  { [[ "$1" =~ ^[0-9]+$ ]]; }
is_wall() { [[ "$1" =~ ^[0-9]+:[0-9]+:[0-9]+$ ]]; }
is_name() { [[ "$1" =~ ^[a-zA-Z0-9_.-]+$ ]]; }

FUN_FACTS=(
    "The first neural network (Perceptron) was built in 1958 by Frank Rosenblatt."
    "GPT-3 has 175 billion parameters â€” more than the number of stars in the Milky Way."
    "The term 'bug' originated from an actual moth found in a computer relay in 1947."
    "The first computer programmer was Ada Lovelace, who wrote algorithms in the 1840s."
    "The Python language is named after Monty Python, not the snake."
    "AlphaGo's move 37 in game 2 against Lee Sedol had a 1 in 10,000 chance of being played by a human."
    "The first 1GB hard drive (1980) weighed 550 pounds and cost \$40,000."
    "Transformer models get their name from the 'Attention Is All You Need' paper (2017)."
    "The first email was sent by Ray Tomlinson in 1971 â€” he can't remember what it said."
    "The moon landing computer had 74KB of memory â€” less than a single emoji image."
    "Backpropagation was popularized in 1986 but invented in the 1960s."
    "The term 'artificial intelligence' was coined at Dartmouth College in 1956."
    "Linux runs on 100% of the world's top 500 supercomputers."
    "The first computer virus, Creeper, was created in 1971 as an experiment."
    "Batch normalization (2015) accidentally became one of deep learning's greatest tricks."
    "The ImageNet dataset that sparked the deep learning revolution contains 14 million images."
    "Dennis Ritchie created C and co-created Unix â€” the foundations of modern computing."
    "The first webcam was invented at Cambridge to monitor a coffee pot."
    "A floppy disk's save icon outlived the floppy disk by decades."
    "Claude Shannon's 1948 paper single-handedly founded information theory."
)

welcome() {
    local fact="${FUN_FACTS[$((RANDOM % ${#FUN_FACTS[@]}))]}"
    echo ""
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${BLUE}â•‘${NC}  ${BOLD}â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—${NC}                  ${BLUE}â•‘${NC}"
    echo -e "${BLUE}â•‘${NC}  ${BOLD}â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•${NC}                  ${BLUE}â•‘${NC}"
    echo -e "${BLUE}â•‘${NC}  ${BOLD}â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘${NC}                       ${BLUE}â•‘${NC}"
    echo -e "${BLUE}â•‘${NC}  ${BOLD}â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•‘${NC}                       ${BLUE}â•‘${NC}"
    echo -e "${BLUE}â•‘${NC}  ${BOLD}â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—${NC}                  ${BLUE}â•‘${NC}"
    echo -e "${BLUE}â•‘${NC}  ${BOLD}â•šâ•â•  â•šâ•â•â•šâ•â•      â•šâ•â•â•â•â•â•${NC}                 ${BLUE}â•‘${NC}"
    echo -e "${BLUE}â•‘${NC}   ${DIM}LIP6 HPC Cluster Manager${NC}                ${BLUE}â•‘${NC}"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "  ${CYAN}ðŸ’¡ ${fact}${NC}"
}

show_menu() {
    echo ""
    echo -e "${BOLD}What do you want to do?${NC}"
    echo ""
    echo -e "  ${GREEN}1${NC})  Launch a new session"
    echo -e "  ${GREEN}2${NC})  Reconnect to a running session"
    echo -e "  ${GREEN}3${NC})  View my jobs"
    echo -e "  ${GREEN}4${NC})  Cancel jobs"
    echo -e "  ${GREEN}5${NC})  SSH into login node"
    echo -e "  ${GREEN}6${NC})  Disconnect tunnel"
    echo -e "  ${RED}q${NC})  Quit"
    echo ""
}

launch_session() {
    echo ""
    echo -e "${BOLD}How many cores?${NC}"
    echo -e "  ${DIM}Press Enter for 24${NC}"
    read -p "> " cores
    cores="${cores:-24}"
    if ! is_int "$cores"; then
        echo -e "${RED}Core count must be a number (e.g. 4, 12, 24).${NC}"
        return
    fi

    echo ""
    echo -e "${BOLD}How long do you need?${NC}"
    echo -e "  ${DIM}Press Enter for 24 hours (format: H:M:S)${NC}"
    read -p "> " wall
    wall="${wall:-24:0:0}"
    if ! is_wall "$wall"; then
        echo -e "${RED}Invalid format. Use H:M:S (e.g. 8:0:0 or 24:0:0).${NC}"
        return
    fi

    echo ""
    echo -e "${BOLD}How do you want to work?${NC}"
    echo -e "  ${GREEN}1${NC})  Jupyter Lab (opens in browser)"
    echo -e "  ${GREEN}2${NC})  Terminal only (SSH into compute node)"
    echo -e "  ${GREEN}3${NC})  Both (Jupyter + terminal access)"
    echo ""
    read -p "> " mode
    mode="${mode:-1}"
    if ! [[ "$mode" =~ ^[1-3]$ ]]; then
        echo -e "${RED}Choose 1, 2, or 3.${NC}"
        return
    fi

    echo ""
    echo -e "${CYAN}Submitting job: ${cores} cores, ${wall}...${NC}"

    if [ "$mode" = "2" ]; then
        echo ""
        echo -e "${YELLOW}Terminal mode requires an interactive OAR session.${NC}"
        echo -e "Opening SSH to the cluster..."
        echo ""
        echo -e "${DIM}Run this on the cluster:${NC}"
        echo -e "  ${GREEN}oarsub -l /nodes=1/core=${cores},walltime=${wall} -p \"host like 'big%'\" -I${NC}"
        echo ""
        ssh hpc
        return
    fi

    JOBID=$(ssh hpc bash -s "$cores" "$wall" << 'REMOTE'
CORES="$1"
WALL="$2"
cat > ~/._jupyter_job.sh << JOBSCRIPT
#!/bin/bash
#OAR -l {host like 'big1%'}/nodes=1/core=${CORES},walltime=${WALL}
#OAR --notify mail:allaa.boutaleb@lip6.fr

source /etc/profile.d/modules.sh
module purge
module load python/anaconda3
eval "\$(conda shell.bash hook)"
conda activate sqale

JUPYTER_PORT=\$(shuf -i 10000-60000 -n 1)
jupyter lab --ip=0.0.0.0 --no-browser --port=\${JUPYTER_PORT}
JOBSCRIPT
chmod +x ~/._jupyter_job.sh
oarsub -S ~/._jupyter_job.sh 2>&1 | grep -oP 'OAR_JOB_ID=\K[0-9]+'
REMOTE
    )

    if [ -z "$JOBID" ] || ! is_int "$JOBID"; then
        echo -e "${RED}Failed to submit job.${NC}"
        return
    fi

    echo -e "${GREEN}Job $JOBID submitted.${NC} Waiting for it to start..."
    sleep 5

    local attempts=0
    while true; do
        STATE=$(ssh hpc "oarstat -f -j '$JOBID' 2>/dev/null | grep 'state =' | head -1 | awk -F= '{print \$2}' | tr -d ' '")
        if [ "$STATE" = "Running" ]; then
            break
        elif [ "$STATE" = "Error" ] || [ "$STATE" = "Terminated" ]; then
            echo -e "${RED}Job failed (state: $STATE)${NC}"
            echo -e "Check logs: ${DIM}ssh hpc 'cat ~/OAR.${JOBID}.stderr'${NC}"
            return
        fi
        attempts=$((attempts + 1))
        if [ $attempts -gt 60 ]; then
            echo -e "${YELLOW}Still queued after 5 min. Job $JOBID is waiting for resources.${NC}"
            echo -e "Use option 2 to connect later, or option 4 to cancel."
            return
        fi
        echo -e "  ${DIM}${STATE:-Queued}... ($((attempts * 5))s)${NC}"
        sleep 5
    done

    connect_to_job "$JOBID" "$mode"
}

connect_to_job() {
    local jobid="$1"
    local mode="${2:-1}"

    local node
    node=$(ssh hpc "oarstat -f -j '$jobid' 2>/dev/null | grep 'assigned_hostnames' | awk '{print \$3}'")
    if [ -z "$node" ] || ! is_name "$node"; then
        echo -e "${RED}Could not find node for job $jobid${NC}"
        return
    fi

    echo -e "${CYAN}Running on ${BOLD}$node${NC}${CYAN}. Waiting for Jupyter...${NC}"

    local url=""
    for i in $(seq 1 30); do
        url=$(ssh hpc "grep -o 'http://[^ ]*' ~/OAR.'${jobid}'.stderr 2>/dev/null | tail -1")
        if [ -n "$url" ]; then
            break
        fi
        sleep 2
    done

    if [ -z "$url" ]; then
        echo -e "${RED}Jupyter didn't start.${NC}"
        echo -e "Check logs: ${DIM}ssh hpc 'cat ~/OAR.${jobid}.stderr'${NC}"
        return
    fi

    # Parse actual port from Jupyter URL
    local remote_port
    remote_port=$(echo "$url" | grep -oP ':\K[0-9]+(?=/)' | head -1)
    if ! is_int "$remote_port"; then
        echo -e "${RED}Could not determine Jupyter port.${NC}"
        return
    fi
    local local_port
    local_port=$(find_free_port)
    local local_url
    local_url=$(echo "$url" | sed "s|http://[^:]*:${remote_port}|http://localhost:${local_port}|")

    echo ""
    echo -e "${GREEN}================================================${NC}"
    echo -e "${GREEN}  Session ready!${NC}"
    echo -e "${GREEN}================================================${NC}"
    echo ""
    echo -e "  ${BOLD}Job:${NC}   $jobid"
    echo -e "  ${BOLD}Node:${NC}  $node"
    echo -e "  ${BOLD}URL:${NC}   ${CYAN}$local_url${NC}"
    echo ""

    # Start tunnel in background
    ssh -N -L "${local_port}:${node}:${remote_port}" hpc &
    local tunnel_pid=$!
    sleep 1
    if ! kill -0 "$tunnel_pid" 2>/dev/null; then
        echo -e "${RED}Tunnel failed to start.${NC}"
        return
    fi
    echo "$tunnel_pid $local_port" > "${TUNNEL_DIR}/${jobid}"
    echo -e "${GREEN}Tunnel running in background (PID $tunnel_pid).${NC}"
    echo -e "${DIM}Use option 6 to disconnect.${NC}"

    echo -e "${CYAN}Opening Jupyter in browser...${NC}"
    if command -v xdg-open &>/dev/null; then
        xdg-open "$local_url" 2>/dev/null &
    elif command -v open &>/dev/null; then
        open "$local_url" &
    fi

    if [ "$mode" = "3" ]; then
        echo ""
        echo -e "${BOLD}To open a terminal on $node, run in another tab:${NC}"
        echo ""
        echo -e "  ${GREEN}ssh -t hpc \"OAR_JOB_ID=$jobid oarsh $node\"${NC}"
        echo ""
        echo -e "${DIM}Or with Kitty:${NC}"
        echo ""
        echo -e "  ${GREEN}kitty +kitten ssh -t hpc \"OAR_JOB_ID=$jobid oarsh $node\"${NC}"
    fi
}

my_jobs() {
    echo ""
    echo -e "${DIM}Loading, please wait...${NC}"
    local output
    output=$(ssh hpc "oarstat -u boutalebm 2>/dev/null")
    if echo "$output" | grep -q "^[0-9]"; then
        echo -e "${BOLD}Your jobs:${NC}"
        echo ""
        echo "$output"
    else
        echo -e "${DIM}No running jobs.${NC}"
    fi
    echo ""
}

cancel_job() {
    echo ""
    echo -e "${DIM}Loading, please wait...${NC}"
    local output
    output=$(ssh hpc "oarstat -u boutalebm 2>/dev/null")
    if ! echo "$output" | grep -q "^[0-9]"; then
        echo -e "${DIM}No running jobs to cancel.${NC}"
        return
    fi
    echo -e "${BOLD}Your jobs:${NC}"
    echo ""
    echo "$output"
    echo ""
    echo -e "Enter a job ID to cancel, or ${BOLD}all${NC} to cancel everything."
    read -p "> " jobid
    if [ "$jobid" = "all" ]; then
        ssh hpc "for jid in \$(oarstat -u boutalebm 2>/dev/null | awk '/^[0-9]/{print \$1}'); do oardel \$jid; rm -f ~/OAR.\${jid}.stderr ~/OAR.\${jid}.stdout; echo \"Cancelled \$jid\"; done"
        echo -e "${GREEN}All jobs cancelled and log files cleaned up.${NC}"
    elif is_int "$jobid"; then
        ssh hpc "oardel '$jobid'; rm -f ~/OAR.'${jobid}'.stderr ~/OAR.'${jobid}'.stdout"
        echo -e "${GREEN}Job $jobid cancelled and log files cleaned up.${NC}"
    elif [ -n "$jobid" ]; then
        echo -e "${RED}Invalid job ID (must be a number).${NC}"
    fi
}

connect_existing() {
    echo ""
    echo -e "${DIM}Loading, please wait...${NC}"
    local output
    output=$(ssh hpc "oarstat -u boutalebm 2>/dev/null")
    if ! echo "$output" | grep -q "^[0-9]"; then
        echo -e "${DIM}No running jobs to connect to.${NC}"
        return
    fi

    local job_ids=($(echo "$output" | awk '/^[0-9]/{print $1}'))
    local jobid=""

    if [ ${#job_ids[@]} -eq 1 ]; then
        jobid="${job_ids[0]}"
        echo -e "Auto-selecting your only running job: ${BOLD}$jobid${NC}"
    else
        echo -e "${BOLD}Your jobs:${NC}"
        echo ""
        echo "$output"
        echo ""
        echo -e "Enter the job ID you want to connect to:"
        read -p "> " jobid
    fi

    if [ -z "$jobid" ]; then
        return
    fi
    if ! is_int "$jobid"; then
        echo -e "${RED}Invalid job ID (must be a number).${NC}"
        return
    fi

    echo ""
    echo -e "${BOLD}How do you want to connect?${NC}"
    echo -e "  ${GREEN}1${NC})  Jupyter Lab (opens in browser)"
    echo -e "  ${GREEN}2${NC})  Terminal only"
    echo -e "  ${GREEN}3${NC})  Both (Jupyter + terminal access)"
    echo ""
    read -p "> " mode
    mode="${mode:-1}"
    if ! [[ "$mode" =~ ^[1-3]$ ]]; then
        echo -e "${RED}Choose 1, 2, or 3.${NC}"
        return
    fi

    if [ "$mode" = "2" ]; then
        local node
        node=$(ssh hpc "oarstat -f -j '$jobid' 2>/dev/null | grep 'assigned_hostnames' | awk '{print \$3}'")
        if [ -z "$node" ] || ! is_name "$node"; then
            echo -e "${RED}Could not find node for job $jobid${NC}"
            return
        fi
        echo -e "${CYAN}Connecting to $node...${NC}"
        ssh -t hpc "OAR_JOB_ID='$jobid' oarsh '$node'"
    else
        connect_to_job "$jobid" "$mode"
    fi
}

sever_tunnel() {
    echo ""
    local found=false
    for f in "$TUNNEL_DIR"/*; do
        [ -f "$f" ] || continue
        local tid
        tid=$(basename "$f")
        local pid port
        read -r pid port < "$f"
        if kill -0 "$pid" 2>/dev/null; then
            echo -e "  ${GREEN}Job $tid${NC} â€” localhost:$port (PID $pid)"
            found=true
        else
            rm -f "$f"
        fi
    done

    if ! $found; then
        echo -e "${DIM}No active tunnels.${NC}"
        return
    fi

    echo ""
    echo -e "Enter a job ID to disconnect, or ${BOLD}all${NC} to disconnect everything."
    read -p "> " choice
    if [ "$choice" = "all" ]; then
        for f in "$TUNNEL_DIR"/*; do
            [ -f "$f" ] || continue
            read -r pid port < "$f"
            kill "$pid" 2>/dev/null
            rm -f "$f"
        done
        echo -e "${GREEN}All tunnels disconnected.${NC}"
    elif is_int "$choice" && [ -f "${TUNNEL_DIR}/${choice}" ]; then
        read -r pid port < "${TUNNEL_DIR}/${choice}"
        kill "$pid" 2>/dev/null
        rm -f "${TUNNEL_DIR}/${choice}"
        echo -e "${GREEN}Tunnel for job $choice disconnected.${NC}"
    elif [ -n "$choice" ]; then
        echo -e "${RED}Invalid choice.${NC}"
    fi
}

# Entry point
welcome

while true; do
    show_menu
    read -p "> " choice
    case $choice in
        1) launch_session ;;
        2) connect_existing ;;
        3) my_jobs ;;
        4) cancel_job ;;
        5) ssh hpc ;;
        6) sever_tunnel ;;
        q|Q) echo -e "\n${DIM}Bye!${NC}\n"; exit 0 ;;
        *) echo -e "${RED}Invalid choice.${NC}" ;;
    esac
done
