#!/bin/bash
# HPC Manager for LIP6 Cluster
# Allaa Boutaleb - allaa.boutaleb@lip6.fr
set -e

BLUE='\033[1;34m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
RED='\033[1;31m'
CYAN='\033[1;36m'
DIM='\033[2m'
BOLD='\033[1m'
NC='\033[0m'

# ---- Input validation ----

is_int()  { [[ "$1" =~ ^[0-9]+$ ]]; }
is_wall() { [[ "$1" =~ ^[0-9]+:[0-9]+:[0-9]+$ ]]; }
is_name() { [[ "$1" =~ ^[a-zA-Z0-9_.-]+$ ]]; }

welcome() {
    echo ""
    echo -e "${BLUE}================================================${NC}"
    echo -e "${BOLD}         LIP6 HPC Cluster Manager${NC}"
    echo -e "${DIM}    Allaa Boutaleb - allaa.boutaleb@lip6.fr${NC}"
    echo -e "${BLUE}================================================${NC}"
}

show_menu() {
    echo ""
    echo -e "${BOLD}What do you want to do?${NC}"
    echo ""
    echo -e "  ${GREEN}1${NC})  Launch a new session"
    echo -e "  ${GREEN}2${NC})  Reconnect to a running session"
    echo -e "  ${GREEN}3${NC})  View my jobs"
    echo -e "  ${GREEN}4${NC})  Cancel jobs"
    echo -e "  ${GREEN}5${NC})  SSH into login node"
    echo -e "  ${RED}q${NC})  Quit"
    echo ""
}

launch_session() {
    echo ""
    echo -e "${BOLD}How many cores?${NC}"
    echo -e "  ${DIM}Press Enter for 24${NC}"
    read -p "> " cores
    cores="${cores:-24}"
    if ! is_int "$cores"; then
        echo -e "${RED}Core count must be a number (e.g. 4, 12, 24).${NC}"
        return
    fi

    echo ""
    echo -e "${BOLD}How long do you need?${NC}"
    echo -e "  ${DIM}Press Enter for 24 hours (format: H:M:S)${NC}"
    read -p "> " wall
    wall="${wall:-24:0:0}"
    if ! is_wall "$wall"; then
        echo -e "${RED}Invalid format. Use H:M:S (e.g. 8:0:0 or 24:0:0).${NC}"
        return
    fi

    echo ""
    echo -e "${BOLD}How do you want to work?${NC}"
    echo -e "  ${GREEN}1${NC})  Jupyter Lab (opens in browser)"
    echo -e "  ${GREEN}2${NC})  Terminal only (SSH into compute node)"
    echo -e "  ${GREEN}3${NC})  Both (Jupyter + terminal access)"
    echo ""
    read -p "> " mode
    mode="${mode:-1}"
    if ! [[ "$mode" =~ ^[1-3]$ ]]; then
        echo -e "${RED}Choose 1, 2, or 3.${NC}"
        return
    fi

    local port=8888

    echo ""
    echo -e "${CYAN}Submitting job: ${cores} cores, ${wall}...${NC}"

    if [ "$mode" = "2" ]; then
        echo ""
        echo -e "${YELLOW}Terminal mode requires an interactive OAR session.${NC}"
        echo -e "Opening SSH to the cluster..."
        echo ""
        echo -e "${DIM}Run this on the cluster:${NC}"
        echo -e "  ${GREEN}oarsub -l /nodes=1/core=${cores},walltime=${wall} -p \"host like 'big%'\" -I${NC}"
        echo ""
        ssh hpc
        return
    fi

    JOBID=$(ssh hpc bash -s "$cores" "$wall" "$port" << 'REMOTE'
CORES="$1"
WALL="$2"
PORT="$3"
cat > ~/._jupyter_job.sh << JOBSCRIPT
#!/bin/bash
#OAR -l {host like 'big1%'}/nodes=1/core=${CORES},walltime=${WALL}
#OAR --notify mail:allaa.boutaleb@lip6.fr

source /etc/profile.d/modules.sh
module purge
module load python/anaconda3
eval "\$(conda shell.bash hook)"
conda activate sqale

jupyter lab --ip=0.0.0.0 --no-browser --port=${PORT}
JOBSCRIPT
chmod +x ~/._jupyter_job.sh
oarsub -S ~/._jupyter_job.sh 2>&1 | grep -oP 'OAR_JOB_ID=\K[0-9]+'
REMOTE
    )

    if [ -z "$JOBID" ] || ! is_int "$JOBID"; then
        echo -e "${RED}Failed to submit job.${NC}"
        return
    fi

    echo -e "${GREEN}Job $JOBID submitted.${NC} Waiting for it to start..."
    sleep 5

    local attempts=0
    while true; do
        STATE=$(ssh hpc "oarstat -f -j '$JOBID' 2>/dev/null | grep 'state =' | head -1 | awk -F= '{print \$2}' | tr -d ' '")
        if [ "$STATE" = "Running" ]; then
            break
        elif [ "$STATE" = "Error" ] || [ "$STATE" = "Terminated" ]; then
            echo -e "${RED}Job failed (state: $STATE)${NC}"
            echo -e "Check logs: ${DIM}ssh hpc 'cat ~/OAR.${JOBID}.stderr'${NC}"
            return
        fi
        attempts=$((attempts + 1))
        if [ $attempts -gt 60 ]; then
            echo -e "${YELLOW}Still queued after 5 min. Job $JOBID is waiting for resources.${NC}"
            echo -e "Use option 2 to connect later, or option 4 to cancel."
            return
        fi
        echo -e "  ${DIM}${STATE:-Queued}... ($((attempts * 5))s)${NC}"
        sleep 5
    done

    connect_to_job "$JOBID" "$port" "$mode"
}

connect_to_job() {
    local jobid="$1"
    local port="${2:-8888}"
    local mode="${3:-1}"

    local node
    node=$(ssh hpc "oarstat -f -j '$jobid' 2>/dev/null | grep 'assigned_hostnames' | awk '{print \$3}'")
    if [ -z "$node" ] || ! is_name "$node"; then
        echo -e "${RED}Could not find node for job $jobid${NC}"
        return
    fi

    echo -e "${CYAN}Running on ${BOLD}$node${NC}${CYAN}. Waiting for Jupyter...${NC}"

    local url=""
    for i in $(seq 1 30); do
        url=$(ssh hpc "grep -o 'http://[^ ]*' ~/OAR.'${jobid}'.stderr 2>/dev/null | tail -1")
        if [ -n "$url" ]; then
            break
        fi
        sleep 2
    done

    if [ -z "$url" ]; then
        echo -e "${RED}Jupyter didn't start.${NC}"
        echo -e "Check logs: ${DIM}ssh hpc 'cat ~/OAR.${jobid}.stderr'${NC}"
        return
    fi

    # Parse actual port from Jupyter URL (handles port conflicts)
    local actual_port
    actual_port=$(echo "$url" | grep -oP ':\K[0-9]+(?=/)' | head -1)
    actual_port="${actual_port:-$port}"
    local local_url
    local_url=$(echo "$url" | sed "s|http://[^:]*:|http://localhost:|")

    echo ""
    echo -e "${GREEN}================================================${NC}"
    echo -e "${GREEN}  Session ready!${NC}"
    echo -e "${GREEN}================================================${NC}"
    echo ""
    echo -e "  ${BOLD}Job:${NC}   $jobid"
    echo -e "  ${BOLD}Node:${NC}  $node"
    echo -e "  ${BOLD}URL:${NC}   ${CYAN}$local_url${NC}"
    echo ""

    if [ "$mode" = "3" ]; then
        echo -e "${CYAN}Opening Jupyter in browser...${NC}"
        if command -v xdg-open &>/dev/null; then
            xdg-open "$local_url" 2>/dev/null &
        elif command -v open &>/dev/null; then
            open "$local_url" &
        fi
        echo ""
        echo -e "${BOLD}To open a terminal on $node, run in another tab:${NC}"
        echo ""
        echo -e "  ${GREEN}ssh -t hpc \"OAR_JOB_ID=$jobid oarsh $node\"${NC}"
        echo ""
        echo -e "${DIM}Or with Kitty:${NC}"
        echo ""
        echo -e "  ${GREEN}kitty +kitten ssh -t hpc \"OAR_JOB_ID=$jobid oarsh $node\"${NC}"
        echo ""
        echo -e "${DIM}Tunnel active. Ctrl+C to disconnect (job keeps running).${NC}"
        echo ""
        ssh -N -L "${actual_port}:${node}:${actual_port}" hpc
    elif [ "$mode" = "1" ]; then
        echo -e "${CYAN}Opening Jupyter in browser...${NC}"
        if command -v xdg-open &>/dev/null; then
            xdg-open "$local_url" 2>/dev/null &
        elif command -v open &>/dev/null; then
            open "$local_url" &
        fi
        echo -e "${DIM}Tunnel active. Ctrl+C to disconnect (job keeps running).${NC}"
        echo ""
        ssh -N -L "${actual_port}:${node}:${actual_port}" hpc
    fi
}

my_jobs() {
    echo ""
    local output
    output=$(ssh hpc "oarstat -u boutalebm 2>/dev/null")
    if echo "$output" | grep -q "^[0-9]"; then
        echo -e "${BOLD}Your jobs:${NC}"
        echo ""
        echo "$output"
    else
        echo -e "${DIM}No running jobs.${NC}"
    fi
    echo ""
}

cancel_job() {
    echo ""
    local output
    output=$(ssh hpc "oarstat -u boutalebm 2>/dev/null")
    if ! echo "$output" | grep -q "^[0-9]"; then
        echo -e "${DIM}No running jobs to cancel.${NC}"
        return
    fi
    echo -e "${BOLD}Your jobs:${NC}"
    echo ""
    echo "$output"
    echo ""
    echo -e "Enter a job ID, or ${BOLD}all${NC} to cancel everything."
    read -p "> " jobid
    if [ "$jobid" = "all" ]; then
        ssh hpc "for jid in \$(oarstat -u boutalebm 2>/dev/null | awk '/^[0-9]/{print \$1}'); do oardel \$jid; echo \"Cancelled \$jid\"; done"
        echo -e "${GREEN}Done.${NC}"
    elif is_int "$jobid"; then
        ssh hpc "oardel '$jobid'"
        echo -e "${GREEN}Job $jobid cancelled.${NC}"
    elif [ -n "$jobid" ]; then
        echo -e "${RED}Invalid job ID (must be a number).${NC}"
    fi
}

connect_existing() {
    echo ""
    local output
    output=$(ssh hpc "oarstat -u boutalebm 2>/dev/null")
    if ! echo "$output" | grep -q "^[0-9]"; then
        echo -e "${DIM}No running jobs to connect to.${NC}"
        return
    fi

    local job_ids=($(echo "$output" | awk '/^[0-9]/{print $1}'))
    local jobid=""

    if [ ${#job_ids[@]} -eq 1 ]; then
        jobid="${job_ids[0]}"
        echo -e "Auto-selecting your only running job: ${BOLD}$jobid${NC}"
    else
        echo -e "${BOLD}Your jobs:${NC}"
        echo ""
        echo "$output"
        echo ""
        echo -e "Which job do you want to connect to?"
        read -p "> " jobid
    fi

    if [ -z "$jobid" ]; then
        return
    fi
    if ! is_int "$jobid"; then
        echo -e "${RED}Invalid job ID (must be a number).${NC}"
        return
    fi

    echo ""
    echo -e "${BOLD}How do you want to connect?${NC}"
    echo -e "  ${GREEN}1${NC})  Jupyter Lab (opens in browser)"
    echo -e "  ${GREEN}2${NC})  Terminal only"
    echo -e "  ${GREEN}3${NC})  Both (Jupyter + terminal access)"
    echo ""
    read -p "> " mode
    mode="${mode:-1}"
    if ! [[ "$mode" =~ ^[1-3]$ ]]; then
        echo -e "${RED}Choose 1, 2, or 3.${NC}"
        return
    fi

    if [ "$mode" = "2" ]; then
        local node
        node=$(ssh hpc "oarstat -f -j '$jobid' 2>/dev/null | grep 'assigned_hostnames' | awk '{print \$3}'")
        if [ -z "$node" ] || ! is_name "$node"; then
            echo -e "${RED}Could not find node for job $jobid${NC}"
            return
        fi
        echo -e "${CYAN}Connecting to $node...${NC}"
        ssh -t hpc "OAR_JOB_ID='$jobid' oarsh '$node'"
    else
        connect_to_job "$jobid" 8888 "$mode"
    fi
}

# Entry point
welcome

while true; do
    show_menu
    read -p "> " choice
    case $choice in
        1) launch_session ;;
        2) connect_existing ;;
        3) my_jobs ;;
        4) cancel_job ;;
        5) ssh hpc ;;
        q|Q) echo -e "\n${DIM}Bye!${NC}\n"; exit 0 ;;
        *) echo -e "${RED}Invalid choice.${NC}" ;;
    esac
done
